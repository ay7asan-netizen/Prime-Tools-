<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prime Tools โ Admin</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="card">
    <div class="header">
      <div class="brand">
        <h1 data-i18n="adminTitle">ููุญุฉ ุงูุฅุฏุงุฑุฉ</h1>
        <small><a class="link" href="index.html" data-i18n="backHome">ุงูุนูุฏุฉ ููุฏุฎูู</a></small>
      </div>
      <div class="lang-switch">
        <button class="lang" data-lang="ar" data-i18n="langAr">AR</button>
        <button class="lang" data-lang="en" data-i18n="langEn">EN</button>
        <button class="lang" data-lang="de" data-i18n="langDe">DE</button>
      </div>
    </div>

    <p id="guard" class="error" style="display:none" data-i18n="notAdmin">ูุง ุชููู ุตูุงุญูุฉ ุงูุฏุฎูู ููุฐู ุงูุตูุญุฉ.</p>

    <section id="adminPanel" style="display:none">
      <!-- ุฅุถุงูุฉ ูุณุชุฎุฏู -->
      <h2 data-i18n="addUser">ุฅุถุงูุฉ ูุณุชุฎุฏู</h2>
      <form id="addUserForm" class="form">
        <div class="row">
          <div>
            <label data-i18n="firstName">ุงูุงุณู ุงูุฃูู</label>
            <input id="firstName" required />
          </div>
          <div>
            <label data-i18n="lastName">ุงุณู ุงูุนุงุฆูุฉ</label>
            <input id="lastName" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label data-i18n="emailLabel">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
            <input id="newEmail" type="email" required />
          </div>
          <div class="password-wrap">
            <label data-i18n="passLabel">ูููุฉ ุงููุฑูุฑ</label>
            <input id="newPass" type="password" required />
            <button type="button" class="eye" id="toggleNewPwd">๐๏ธ</button>
          </div>
        </div>
        <label data-i18n="address">ุงูุนููุงู</label>
        <input id="address" />

        <div class="row">
          <div>
            <label data-i18n="status">ุงูุญุงูุฉ</label>
            <select id="status">
              <option value="approved" data-i18n="approved">ููุนุชูุฏ</option>
              <option value="pending" data-i18n="pending">ููุฏ ุงูุงูุชุธุงุฑ</option>
            </select>
          </div>
          <label class="keep"><input type="checkbox" id="isAdmin" /> <span data-i18n="isAdmin">ุฃุฏูู</span></label>
        </div>

        <button class="btn btn-primary" type="submit" data-i18n="createUser">ุฅูุดุงุก ุงููุณุชุฎุฏู</button>
        <span id="addUserMsg" class="notice"></span>
      </form>

      <!-- ูุงุฆูุฉ ุงููุณุชุฎุฏููู -->
      <h2 style="margin-top:24px" data-i18n="usersList">ุงููุณุชุฎุฏููู</h2>
      <table class="table" id="usersTable">
        <thead>
          <tr>
            <th data-i18n="thName">ุงูุงุณู</th>
            <th data-i18n="thEmail">ุงูุจุฑูุฏ</th>
            <th data-i18n="thStatus">ุงูุญุงูุฉ</th>
            <th data-i18n="thAdmin">ุฃุฏูู</th>
            <th data-i18n="thActions">ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- ุฅุฏุงุฑุฉ ุงูุฃุฏูุงุช -->
      <h2 style="margin-top:24px" data-i18n="toolsTitle">ุงูุฃุฏูุงุช</h2>
      <form id="addToolForm" class="form" style="grid-template-columns:3fr auto;align-items:center">
        <input id="toolName" placeholder="Tool nameโฆ" required />
        <button class="btn" type="submit" data-i18n="addTool">ุฅุถุงูุฉ ุฃุฏุงุฉ</button>
      </form>
      <table class="table" id="toolsTable">
        <thead>
          <tr><th data-i18n="thTool">ุงูุฃุฏุงุฉ</th><th data-i18n="thActions">ุฅุฌุฑุงุกุงุช</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- Firebase v9 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, getDocs, collection, updateDoc, deleteDoc, addDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // === Config (ุญุณุจ ูุดุฑูุนู) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCEbKMZHqJQ-UU6Qco7FlAue0E4mCWd4UY",
      authDomain: "prime-tools99.firebaseapp.com",
      projectId: "prime-tools99",
      storageBucket: "prime-tools99.appspot.com",
      messagingSenderId: "112360376529",
      appId: "1:112360376529:web:f5fac1d99a87f7f5a85df0",
      measurementId: "G-WR5IJ3CZ3K"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== I18N =====
    const t = {
      ar:{adminTitle:"ููุญุฉ ุงูุฅุฏุงุฑุฉ",backHome:"ุงูุนูุฏุฉ ููุฏุฎูู",langAr:"AR",langEn:"EN",langDe:"DE",notAdmin:"ูุง ุชููู ุตูุงุญูุฉ ุงูุฏุฎูู ููุฐู ุงูุตูุญุฉ.",
          addUser:"ุฅุถุงูุฉ ูุณุชุฎุฏู",firstName:"ุงูุงุณู ุงูุฃูู",lastName:"ุงุณู ุงูุนุงุฆูุฉ",emailLabel:"ุงูุจุฑูุฏ ุงูุฅููุชุฑููู",
          passLabel:"ูููุฉ ุงููุฑูุฑ",address:"ุงูุนููุงู",status:"ุงูุญุงูุฉ",approved:"ููุนุชูุฏ",pending:"ููุฏ ุงูุงูุชุธุงุฑ",isAdmin:"ุฃุฏูู",
          createUser:"ุฅูุดุงุก ุงููุณุชุฎุฏู",usersList:"ุงููุณุชุฎุฏููู",thName:"ุงูุงุณู",thEmail:"ุงูุจุฑูุฏ",thStatus:"ุงูุญุงูุฉ",thAdmin:"ุฃุฏูู",thActions:"ุฅุฌุฑุงุกุงุช",
          toolsTitle:"ุงูุฃุฏูุงุช",addTool:"ุฅุถุงูุฉ ุฃุฏุงุฉ",thTool:"ุงูุฃุฏุงุฉ",
          msgCreated:"ุชู ุฅูุดุงุก ุงููุณุชุฎุฏู",msgUpdated:"ุชู ุงูุชุญุฏูุซ",msgDeleted:"ุชู ุงูุญุฐู"},
      en:{adminTitle:"Admin Panel",backHome:"Back to Login",langAr:"AR",langEn:"EN",langDe:"DE",notAdmin:"You don't have access to this page.",
          addUser:"Add User",firstName:"First name",lastName:"Last name",emailLabel:"E-mail",
          passLabel:"Password",address:"Address",status:"Status",approved:"Approved",pending:"Pending",isAdmin:"Admin",
          createUser:"Create user",usersList:"Users",thName:"Name",thEmail:"E-mail",thStatus:"Status",thAdmin:"Admin",thActions:"Actions",
          toolsTitle:"Tools",addTool:"Add Tool",thTool:"Tool",
          msgCreated:"User created",msgUpdated:"Updated",msgDeleted:"Deleted"},
      de:{adminTitle:"Adminbereich",backHome:"Zur Anmeldung",langAr:"AR",langEn:"EN",langDe:"DE",notAdmin:"Kein Zugriff auf diese Seite.",
          addUser:"Benutzer hinzufรผgen",firstName:"Vorname",lastName:"Nachname",emailLabel:"E-Mail",
          passLabel:"Passwort",address:"Adresse",status:"Status",approved:"Freigegeben",pending:"Ausstehend",isAdmin:"Admin",
          createUser:"Benutzer erstellen",usersList:"Benutzer",thName:"Name",thEmail:"E-Mail",thStatus:"Status",thAdmin:"Admin",thActions:"Aktionen",
          toolsTitle:"Tools",addTool:"Tool hinzufรผgen",thTool:"Tool",
          msgCreated:"Benutzer erstellt",msgUpdated:"Aktualisiert",msgDeleted:"Gelรถscht"}
    };
    const DIR={ar:"rtl",en:"ltr",de:"ltr"};
    let currentLang=localStorage.getItem("lang")||"ar";
    function i18nApply(){
      const tt=t[currentLang];
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k=el.getAttribute("data-i18n"); if(tt[k]!==undefined) el.textContent=tt[k];
      });
      document.documentElement.lang=currentLang;
      document.documentElement.dir=DIR[currentLang];
      document.querySelectorAll(".lang").forEach(b=>b.classList.toggle("active",b.dataset.lang===currentLang));
    }
    document.querySelectorAll(".lang").forEach(btn=>btn.addEventListener("click",()=>{currentLang=btn.dataset.lang;localStorage.setItem("lang",currentLang);i18nApply();}));
    i18nApply();

    // ===== ุญุฑุงุณุฉ ุงูุฃุฏูู =====
    const guard=document.getElementById("guard");
    const panel=document.getElementById("adminPanel");

    async function requireAdmin(user){
      const ref=doc(db,"users",user.uid);
      const snap=await getDoc(ref);
      const isAdmin=snap.exists() && snap.data().isAdmin===true;
      if(!isAdmin){ guard.style.display="block"; panel.style.display="none"; }
      else{ guard.style.display="none"; panel.style.display="block"; loadUsers(); loadTools(); }
    }

    onAuthStateChanged(auth, user=>{
      if(!user){ window.location.href="index.html"; return; }
      requireAdmin(user);
    });

    // ===== ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ =====
    const toggleNewPwd=document.getElementById("toggleNewPwd");
    const newPass=document.getElementById("newPass");
    toggleNewPwd.addEventListener("click",()=>{newPass.type=newPass.type==="password"?"text":"password"});

    document.getElementById("addUserForm").addEventListener("submit",async e=>{
      e.preventDefault();
      const firstName=document.getElementById("firstName").value.trim();
      const lastName=document.getElementById("lastName").value.trim();
      const email=document.getElementById("newEmail").value.trim();
      const pass=document.getElementById("newPass").value.trim();
      const address=document.getElementById("address").value.trim();
      const status=document.getElementById("status").value;
      const isAdmin=document.getElementById("isAdmin").checked;
      const msg=document.getElementById("addUserMsg");

      try{
        // ููุดุฆ ุญุณุงุจ ูููุณุชุฎุฏู ุงูุฌุฏูุฏ ุซู ูุฎุฒู ูุซููุชู
        const cred=await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db,"users",cred.user.uid),{
          firstName,lastName,email,address,status,isAdmin
        });
        msg.textContent=t[currentLang].msgCreated;
      }catch(err){
        msg.classList.add("error"); msg.textContent=err.message;
      }
    });

    // ===== ุงููุณุชุฎุฏููู: ูุฑุงุกุฉ/ุชุญุฏูุซ =====
    async function loadUsers(){
      const tbody=document.querySelector("#usersTable tbody");
      tbody.innerHTML="";
      const snaps=await getDocs(collection(db,"users"));
      snaps.forEach(s=>{
        const u=s.data();
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${u.firstName||""} ${u.lastName||""}</td>
          <td>${u.email||""}</td>
          <td><span class="badge ${u.status==='approved'?'ok':''}">${u.status||""}</span></td>
          <td>${u.isAdmin?'<span class="badge ok">โ</span>':'โ'}</td>
          <td>
            <button class="btn" data-act="approve">Approve</button>
            <button class="btn" data-act="toggleAdmin">${u.isAdmin?'Revoke Admin':'Make Admin'}</button>
            <button class="btn btn-danger" data-act="delete">Delete</button>
          </td>`;
        tr.querySelector('[data-act="approve"]').addEventListener("click",async()=>{
          await updateDoc(doc(db,"users",s.id),{status:"approved"}); loadUsers();
        });
        tr.querySelector('[data-act="toggleAdmin"]').addEventListener("click",async()=>{
          await updateDoc(doc(db,"users",s.id),{isAdmin:!u.isAdmin}); loadUsers();
        });
        tr.querySelector('[data-act="delete"]').addEventListener("click",async()=>{
          await deleteDoc(doc(db,"users",s.id)); loadUsers();
        });
        tbody.appendChild(tr);
      });
    }

    // ===== ุงูุฃุฏูุงุช: ุฅุถุงูุฉ/ุญุฐู =====
    document.getElementById("addToolForm").addEventListener("submit",async e=>{
      e.preventDefault();
      const name=document.getElementById("toolName").value.trim();
      if(!name) return;
      await addDoc(collection(db,"tools"),{name});
      document.getElementById("toolName").value="";
      loadTools();
    });

    async function loadTools(){
      const tbody=document.querySelector("#toolsTable tbody");
      tbody.innerHTML="";
      const snaps=await getDocs(collection(db,"tools"));
      snaps.forEach(s=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${s.data().name}</td>
          <td><button class="btn btn-danger" data-id="${s.id}">Delete</button></td>`;
        tr.querySelector("button").addEventListener("click",async()=>{
          await deleteDoc(doc(db,"tools",s.id)); loadTools();
        });
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
