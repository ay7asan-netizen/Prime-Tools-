<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prime Tools â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <style>
    body{margin:0;background:#0e0e10;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Tajawal,sans-serif}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:#141418;border:1px solid #27272a;border-radius:14px;padding:16px;margin-bottom:14px}
    h1,h2{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #303036;background:#0f0f12;color:#fff}
    button{background:#27b0ff;border:none;font-weight:800;cursor:pointer}
    button:hover{filter:brightness(1.05)}
    .muted{color:#a6a6b0;font-size:14px}
    .list{border:1px solid #2a2a2f;border-radius:12px;overflow:hidden}
    .item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #2a2a2f}
    .item:last-child{border-bottom:0}
    .danger{background:#ff4d4f !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Prime Tools</h1>
      <p class="muted">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† + Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆØ§Øª. (Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø°Ø§ØªÙŠ).</p>
    </div>

    <!-- Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† -->
    <div class="card" id="authCard">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
      <div class="grid">
        <input id="adminEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯" />
        <div style="position:relative">
          <input id="adminPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
          <span id="toggleAdmin" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);cursor:pointer">ğŸ‘ï¸</span>
        </div>
      </div>
      <button id="adminLoginBtn" style="margin-top:10px">Ø¯Ø®ÙˆÙ„</button>
      <div class="muted" id="adminMsg"></div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <div class="card" id="panel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>
        <button id="logoutBtn" class="danger" style="max-width:180px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
      <div class="grid">
        <input id="uFirst" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„" />
        <input id="uLast" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©" />
        <input id="uAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
        <input id="uEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯" />
        <input id="uPass" type="text" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ© (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº Ù„ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ)" />
        <button id="createUserBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
      </div>
      <div id="createMsg" class="muted" style="margin-top:10px"></div>
    </div>

    <div class="card" id="toolsCard" style="display:none">
      <h2>Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø©</h2>
      <div class="grid" style="grid-template-columns:1fr auto">
        <input id="toolName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø©" />
        <button id="addToolBtn">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <h2 style="margin-top:16px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª</h2>
      <div id="toolsList" class="list"></div>
    </div>
  </div>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const cfg = {
      apiKey: "AIzaSyCEbKMZHqJQ-UU6Qco7FlAue0E4mCWd4UY",
      authDomain: "prime-tools99.firebaseapp.com",
      projectId: "prime-tools99",
      storageBucket: "prime-tools99.firebasestorage.app",
      messagingSenderId: "112360376529",
      appId: "1:112360376529:web:f5fac1d99a87f7f5a85df0"
    };
    const appMain = firebase.initializeApp(cfg);
    const auth = appMain.auth();
    const db   = appMain.firestore();

    // ØªØ·Ø¨ÙŠÙ‚ Ø«Ø§Ù†ÙˆÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø§ ÙŠØ·Ù„Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ù† Ø­Ø³Ø§Ø¨Ù‡
    const appSecondary = firebase.initializeApp(cfg, "secondary");
    const auth2 = appSecondary.auth();

    // Ø¹Ù†Ø§ØµØ±
    const authCard   = document.getElementById('authCard');
    const panel      = document.getElementById('panel');
    const toolsCard  = document.getElementById('toolsCard');
    const adminMsg   = document.getElementById('adminMsg');
    const createMsg  = document.getElementById('createMsg');

    document.getElementById('toggleAdmin').onclick = ()=>{
      const p = document.getElementById('adminPass');
      p.type = (p.type === 'password') ? 'text' : 'password';
    };

    // Ø´Ø±Ø· Ø¥Ø¯Ù…Ù†: users/<uid> ÙÙŠÙ‡ isAdmin=true Ø£Ùˆ role='admin'
    async function assertAdmin(user){
      const doc = await db.collection('users').doc(user.uid).get();
      const u = doc.data() || {};
      if (u.isAdmin === true || u.role === 'admin') return true;
      return false;
    }

    // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
    document.getElementById('adminLoginBtn').onclick = async ()=>{
      adminMsg.textContent = '';
      const email = document.getElementById('adminEmail').value.trim();
      const pass  = document.getElementById('adminPass').value;
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        if (await assertAdmin(cred.user)){
          authCard.style.display = 'none';
          panel.style.display = 'block';
          toolsCard.style.display = 'block';
          loadTools();
        } else {
          adminMsg.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„ÙŠØ³ Ø£Ø¯Ù…Ù†.';
          await auth.signOut();
        }
      }catch(e){ adminMsg.textContent = 'Ø®Ø·Ø£: ' + e.message; }
    };

    // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    document.getElementById('logoutBtn').onclick = async ()=>{
      await auth.signOut();
      panel.style.display = 'none';
      toolsCard.style.display = 'none';
      authCard.style.display = 'block';
    };

    // ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¨Ø³ÙŠØ·Ø©
    function genPass(len=10){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%';
      let out=''; for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ (Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ
    document.getElementById('createUserBtn').onclick = async ()=>{
      createMsg.textContent = '';
      const first = document.getElementById('uFirst').value.trim();
      const last  = document.getElementById('uLast').value.trim();
      const addr  = document.getElementById('uAddress').value.trim();
      const email = document.getElementById('uEmail').value.trim();
      let pass    = document.getElementById('uPass').value.trim() || genPass();

      if(!first || !last || !addr || !email){ createMsg.textContent='Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.'; return; }

      try{
        // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ÙŠØ·Ù„Ù‘Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ù† Ø¬Ù„Ø³ØªÙ‡
        const res = await auth2.createUserWithEmailAndPassword(email, pass);
        const uid = res.user.uid;

        // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
        await db.collection('users').doc(uid).set({
          firstName: first,
          lastName:  last,
          address:   addr,
          email:     email,
          status:    'approved',
          isAdmin:   false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ ÙÙˆØ±Ù‹Ø§ (Ø­Ù…Ø§ÙŠØ©)
        await auth2.signOut();

        createMsg.textContent = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©: ' + pass;
        // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
        ['uFirst','uLast','uAddress','uEmail','uPass'].forEach(id=>document.getElementById(id).value='');
      }catch(e){
        createMsg.textContent = 'Ø®Ø·Ø£: ' + e.message;
      }
    };

    // Ø§Ù„Ø£Ø¯ÙˆØ§Øª: Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø· ÙˆØ§Ù„ÙƒÙˆØ¯ ÙŠØªÙˆÙ„Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    document.getElementById('addToolBtn').onclick = async ()=>{
      const name = document.getElementById('toolName').value.trim();
      if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø©'); return; }
      const ref = db.collection('tools').doc();
      const code = 'TOOL:' + ref.id;
      try{
        await ref.set({
          name, code,
          status:'available',
          currentHolder:null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('toolName').value='';
        loadTools();
        alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯Ø§Ø© âœ…');
      }catch(e){ alert('Ø®Ø·Ø£: '+e.message); }
    };

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯ÙˆØ§Øª
    async function loadTools(){
      const box = document.getElementById('toolsList');
      box.innerHTML = '';
      const q = await db.collection('tools').orderBy('createdAt','desc').get();
      if(q.empty){ box.innerHTML = '<div class="item"><span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆØ§Øª</span></div>'; return; }
      q.forEach(doc=>{
        const t = doc.data();
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <div>
            <div><b>${t.name}</b></div>
            <div class="muted">${t.code} â€” Ø§Ù„Ø­Ø§Ù„Ø©: ${t.status||'available'}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="qr-${doc.id}" class="muted" style="padding:6px 8px;border:1px solid #2a2a2f;border-radius:10px">QR</div>
            <button class="danger" data-del>Ø­Ø°Ù</button>
          </div>`;
        row.querySelector('[data-del]').onclick = async ()=>{
          if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø©ØŸ')){ await db.collection('tools').doc(doc.id).delete(); loadTools(); }
        };
        setTimeout(()=>{ new QRCode(document.getElementById('qr-'+doc.id), {text:t.code, width:64, height:64}); },0);
        box.appendChild(row);
      });
    }
  </script>
</body>
</html>
